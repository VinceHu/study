---
title: JavaScript äº‹ä»¶å¾ªç¯æœºåˆ¶ - Event Loop åŸç†ä¸æ‰§è¡Œé¡ºåº
description: æ·±å…¥ç†è§£ JavaScript äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰çš„å·¥ä½œåŸç†ï¼ŒæŒæ¡å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œå­¦ä¹ å¦‚ä½•å¤„ç†å¼‚æ­¥æ“ä½œå’Œé¿å…é˜»å¡é—®é¢˜
keywords: Event Loop, äº‹ä»¶å¾ªç¯, å®ä»»åŠ¡, å¾®ä»»åŠ¡, JavaScriptå¼‚æ­¥, è°ƒç”¨æ ˆ, ä»»åŠ¡é˜Ÿåˆ—, å‰ç«¯é¢è¯•
date: 2025-12-01
category: JavaScript
difficulty: ä¸­çº§
tags: [Event Loop, å¼‚æ­¥ç¼–ç¨‹, å®ä»»åŠ¡, å¾®ä»»åŠ¡, è°ƒç”¨æ ˆ]
related: [async-await.md, promise.md, closure.md]
hasCode: true
---

# é¢˜ç›®

è¯·è¯¦ç»†è¯´æ˜ JavaScript äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼ˆEvent Loopï¼‰çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºã€‚

## ğŸ¯ é¢è¯•é€Ÿç­”

::: tip
äº‹ä»¶å¾ªç¯æ˜¯ JavaScript å¤„ç†å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒæœºåˆ¶ã€‚å› ä¸º JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½åšä¸€ä»¶äº‹ï¼Œæ‰€ä»¥éœ€è¦äº‹ä»¶å¾ªç¯æ¥åè°ƒå„ç§å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

ç®€å•æ¥è¯´ï¼Œäº‹ä»¶å¾ªç¯çš„å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆæ‰§è¡Œæ‰€æœ‰çš„åŒæ­¥ä»£ç ï¼Œç„¶åæ£€æŸ¥æœ‰æ²¡æœ‰å¾®ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œå¦‚æœæœ‰å°±æŠŠæ‰€æœ‰å¾®ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ¥ç€å†æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼Œç„¶ååˆå›åˆ°æ£€æŸ¥å¾®ä»»åŠ¡è¿™ä¸€æ­¥ï¼Œè¿™æ ·ä¸æ–­å¾ªç¯ã€‚

è¿™é‡Œé¢æ¶‰åŠåˆ°ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šè°ƒç”¨æ ˆã€å®ä»»åŠ¡é˜Ÿåˆ—å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è°ƒç”¨æ ˆå°±æ˜¯å­˜æ”¾å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç çš„åœ°æ–¹ï¼Œæ˜¯ä¸€ä¸ªåè¿›å…ˆå‡ºçš„ç»“æ„ã€‚å½“é‡åˆ°å¼‚æ­¥æ“ä½œæ—¶ï¼Œæ¯”å¦‚ setTimeout æˆ–è€… Promiseï¼Œå®ƒä»¬çš„å›è°ƒå‡½æ•°ä¼šè¢«æ”¾åˆ°å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚

å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„åŒºåˆ«å¾ˆé‡è¦ã€‚å®ä»»åŠ¡åŒ…æ‹¬ setTimeoutã€setIntervalã€I/O æ“ä½œè¿™äº›ï¼Œè€Œå¾®ä»»åŠ¡ä¸»è¦æ˜¯ Promise çš„ thenã€catchã€finally å›è°ƒï¼Œè¿˜æœ‰ queueMicrotask è¿™äº›ã€‚å…³é”®ç‚¹æ˜¯å¾®ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å®ä»»åŠ¡é«˜ï¼Œæ¯æ¬¡äº‹ä»¶å¾ªç¯éƒ½ä¼šæŠŠæ‰€æœ‰å¾®ä»»åŠ¡æ¸…ç©ºåï¼Œæ‰ä¼šæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä»£ç é‡Œæ—¢æœ‰ setTimeout åˆæœ‰ Promiseï¼Œé‚£æ‰§è¡Œé¡ºåºä¸€å®šæ˜¯ï¼šå…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œç„¶åæ‰§è¡Œ Promise çš„å›è°ƒï¼Œæœ€åæ‰æ‰§è¡Œ setTimeout çš„å›è°ƒã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå³ä½¿ setTimeout è®¾ç½®å»¶è¿Ÿä¸º 0ï¼Œå®ƒä¹Ÿä¸ä¼šç«‹å³æ‰§è¡Œï¼Œå› ä¸ºå®ƒè¦ç­‰å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºåæ‰è½®åˆ°å®ƒã€‚

å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæµè§ˆå™¨çš„é¡µé¢æ¸²æŸ“é€šå¸¸å‘ç”Ÿåœ¨å®ä»»åŠ¡ä¹‹é—´ï¼Œæ‰€ä»¥å¦‚æœå¾®ä»»åŠ¡å¤ªå¤šæˆ–è€…æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œä¹Ÿä¼šå½±å“é¡µé¢æ¸²æŸ“ï¼Œå¯¼è‡´é¡µé¢å¡é¡¿ã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œç†è§£äº‹ä»¶å¾ªç¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å¤„ç†å¼‚æ­¥æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œé¿å…ä¸€äº›æ„å¤–çš„ bugï¼Œä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–æ€§èƒ½ï¼Œæ¯”å¦‚æŠŠè€—æ—¶çš„æ“ä½œåˆ†ç‰‡æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚
:::

## ğŸ“ æ ‡å‡†ç­”æ¡ˆ

### æ ¸å¿ƒè¦ç‚¹

1. **å•çº¿ç¨‹ç‰¹æ€§**ï¼š
   - JavaScript åœ¨åŒä¸€æ—¶é—´åªèƒ½åšä¸€ä»¶äº‹
   - é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ä¼šé˜»å¡å…¶ä»–ä»»åŠ¡

2. **äº‹ä»¶å¾ªç¯æ ¸å¿ƒç»„ä»¶**ï¼š
   - è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰ï¼šå­˜å‚¨ä»£ç æ‰§è¡Œä½ç½®
   - ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰ï¼šå­˜æ”¾å¾…æ‰§è¡Œçš„å›è°ƒå‡½æ•°
   - äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ï¼šåè°ƒè°ƒç”¨æ ˆå’Œä»»åŠ¡é˜Ÿåˆ—

3. **ä»»åŠ¡åˆ†ç±»**ï¼š
   - å®ä»»åŠ¡ï¼ˆMacro Tasksï¼‰ï¼šsetTimeoutã€setIntervalã€I/Oã€UI æ¸²æŸ“
   - å¾®ä»»åŠ¡ï¼ˆMicro Tasksï¼‰ï¼šPromiseã€queueMicrotaskã€MutationObserver

4. **æ‰§è¡Œé¡ºåº**ï¼š
   - æ‰§è¡ŒåŒæ­¥ä»£ç 
   - æ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡
   - æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡
   - é‡å¤ä¸Šè¿°è¿‡ç¨‹

### è¯¦ç»†è¯´æ˜

#### 1. è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰

è°ƒç”¨æ ˆæ˜¯ä¸€ä¸ªåè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨ä»£ç æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ã€‚

```javascript
function first() {
  console.log('first');
  second();
  console.log('first end');
}

function second() {
  console.log('second');
}

first();

// è°ƒç”¨æ ˆå˜åŒ–ï¼š
// 1. first() å…¥æ ˆ
// 2. console.log('first') å…¥æ ˆ â†’ æ‰§è¡Œ â†’ å‡ºæ ˆ
// 3. second() å…¥æ ˆ
// 4. console.log('second') å…¥æ ˆ â†’ æ‰§è¡Œ â†’ å‡ºæ ˆ
// 5. second() å‡ºæ ˆ
// 6. console.log('first end') å…¥æ ˆ â†’ æ‰§è¡Œ â†’ å‡ºæ ˆ
// 7. first() å‡ºæ ˆ
```

#### 2. ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰

ä»»åŠ¡é˜Ÿåˆ—åˆ†ä¸ºå®ä»»åŠ¡é˜Ÿåˆ—å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾å¼‚æ­¥æ“ä½œçš„å›è°ƒå‡½æ•°ã€‚

```javascript
// å®ä»»åŠ¡ç¤ºä¾‹
setTimeout(() => {
  console.log('setTimeout');
}, 0);

// å¾®ä»»åŠ¡ç¤ºä¾‹
Promise.resolve().then(() => {
  console.log('Promise');
});

console.log('åŒæ­¥ä»£ç ');

// è¾“å‡ºé¡ºåºï¼š
// åŒæ­¥ä»£ç 
// Promise
// setTimeout
```

#### 3. äº‹ä»¶å¾ªç¯æµç¨‹

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
}, 0);

Promise.resolve().then(() => {
  console.log('3');
});

console.log('4');

// æ‰§è¡Œæµç¨‹ï¼š
// 1. æ‰§è¡ŒåŒæ­¥ä»£ç ï¼šè¾“å‡º '1' å’Œ '4'
// 2. setTimeout å›è°ƒè¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—
// 3. Promise å›è°ƒè¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
// 4. åŒæ­¥ä»£ç æ‰§è¡Œå®Œï¼Œæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼šè¾“å‡º '3'
// 5. æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ï¼šè¾“å‡º '2'

// æœ€ç»ˆè¾“å‡ºï¼š1 4 3 2
```

## ğŸ§  æ·±åº¦ç†è§£

### å®ä»»åŠ¡ vs å¾®ä»»åŠ¡

#### å®ä»»åŠ¡ï¼ˆMacro Tasksï¼‰

å®ä»»åŠ¡æ˜¯ç”±å®¿ä¸»ç¯å¢ƒï¼ˆæµè§ˆå™¨æˆ– Node.jsï¼‰æä¾›çš„å¼‚æ­¥ä»»åŠ¡ã€‚

```javascript
// å¸¸è§çš„å®ä»»åŠ¡
setTimeout(() => {}, 0);
setInterval(() => {}, 0);
setImmediate(() => {}); // Node.js
requestAnimationFrame(() => {}); // æµè§ˆå™¨
I/O æ“ä½œ
UI æ¸²æŸ“
```

#### å¾®ä»»åŠ¡ï¼ˆMicro Tasksï¼‰

å¾®ä»»åŠ¡æ˜¯ç”± JavaScript å¼•æ“æä¾›çš„å¼‚æ­¥ä»»åŠ¡ï¼Œä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡ã€‚

```javascript
// å¸¸è§çš„å¾®ä»»åŠ¡
Promise.resolve().then(() => {});
queueMicrotask(() => {});
MutationObserver(() => {}); // æµè§ˆå™¨
process.nextTick(() => {}); // Node.jsï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
```

### æ‰§è¡Œé¡ºåºè¯¦è§£

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
  Promise.resolve().then(() => {
    console.log('3');
  });
}, 0);

Promise.resolve().then(() => {
  console.log('4');
  setTimeout(() => {
    console.log('5');
  }, 0);
});

console.log('6');

// æ‰§è¡Œæµç¨‹åˆ†æï¼š
// 1. æ‰§è¡ŒåŒæ­¥ä»£ç ï¼šè¾“å‡º '1' å’Œ '6'
// 2. æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š
//    - æ‰§è¡Œ Promise.thenï¼šè¾“å‡º '4'
//    - setTimeout è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—
// 3. æ‰§è¡Œç¬¬ä¸€ä¸ªå®ä»»åŠ¡ï¼š
//    - è¾“å‡º '2'
//    - Promise.then è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
// 4. æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼šè¾“å‡º '3'
// 5. æ‰§è¡Œç¬¬äºŒä¸ªå®ä»»åŠ¡ï¼šè¾“å‡º '5'

// æœ€ç»ˆè¾“å‡ºï¼š1 6 4 2 3 5
```

### å¤æ‚ç¤ºä¾‹

```javascript
async function async1() {
  console.log('async1 start');
  await async2();
  console.log('async1 end');
}

async function async2() {
  console.log('async2');
}

console.log('script start');

setTimeout(() => {
  console.log('setTimeout');
}, 0);

async1();

new Promise((resolve) => {
  console.log('promise1');
  resolve();
}).then(() => {
  console.log('promise2');
});

console.log('script end');

// æ‰§è¡Œæµç¨‹ï¼š
// 1. åŒæ­¥ä»£ç ï¼š
//    - 'script start'
//    - 'async1 start'
//    - 'async2'
//    - 'promise1'
//    - 'script end'
// 2. å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š
//    - 'async1 end' (await åé¢çš„ä»£ç )
//    - 'promise2'
// 3. å®ä»»åŠ¡é˜Ÿåˆ—ï¼š
//    - 'setTimeout'

// æœ€ç»ˆè¾“å‡ºï¼š
// script start
// async1 start
// async2
// promise1
// script end
// async1 end
// promise2
// setTimeout
```

### async/await ä¸äº‹ä»¶å¾ªç¯

```javascript
async function foo() {
  console.log('foo start');
  await bar();
  console.log('foo end');
}

async function bar() {
  console.log('bar');
}

foo();
console.log('script end');

// await ç›¸å½“äºï¼š
function foo() {
  console.log('foo start');
  return Promise.resolve(bar()).then(() => {
    console.log('foo end');
  });
}

// è¾“å‡ºï¼š
// foo start
// bar
// script end
// foo end
```

### Node.js ä¸­çš„äº‹ä»¶å¾ªç¯

Node.js çš„äº‹ä»¶å¾ªç¯åˆ†ä¸º 6 ä¸ªé˜¶æ®µï¼š

```javascript
// Node.js äº‹ä»¶å¾ªç¯é˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚  // setTimeoutã€setInterval
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚  // ç³»ç»Ÿæ“ä½œçš„å›è°ƒ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚  // å†…éƒ¨ä½¿ç”¨
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚           poll            â”‚  // I/O å›è°ƒ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚           check           â”‚  // setImmediate
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚  // socket.on('close')
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// process.nextTick å’Œ Promise åœ¨æ¯ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œ
```

#### Node.js ç‰¹æ®Š API

```javascript
// process.nextTickï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
process.nextTick(() => {
  console.log('nextTick');
});

// setImmediateï¼ˆcheck é˜¶æ®µï¼‰
setImmediate(() => {
  console.log('setImmediate');
});

// setTimeoutï¼ˆtimers é˜¶æ®µï¼‰
setTimeout(() => {
  console.log('setTimeout');
}, 0);

Promise.resolve().then(() => {
  console.log('Promise');
});

// è¾“å‡ºé¡ºåºï¼š
// nextTick
// Promise
// setTimeout
// setImmediate
```

### æµè§ˆå™¨æ¸²æŸ“æ—¶æœº

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
  // æµè§ˆå™¨å¯èƒ½åœ¨è¿™é‡Œæ¸²æŸ“
}, 0);

Promise.resolve().then(() => {
  console.log('3');
  // ä¸ä¼šåœ¨è¿™é‡Œæ¸²æŸ“ï¼Œå› ä¸ºå¾®ä»»åŠ¡è¿˜æ²¡æ¸…ç©º
});

console.log('4');

// æ¸²æŸ“æ—¶æœºï¼š
// 1. æ‰§è¡ŒåŒæ­¥ä»£ç 
// 2. æ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡
// 3. æµè§ˆå™¨æ¸²æŸ“ï¼ˆå¦‚æœéœ€è¦ï¼‰
// 4. æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡
```

### å¸¸è§è¯¯åŒº

#### è¯¯åŒº 1ï¼šsetTimeout(fn, 0) ç«‹å³æ‰§è¡Œ

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
}, 0);

console.log('3');

// è¾“å‡ºï¼š1 3 2
// setTimeout çš„å›è°ƒä¼šåœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œï¼Œä¸æ˜¯ç«‹å³æ‰§è¡Œ
```

#### è¯¯åŒº 2ï¼šå¾®ä»»åŠ¡ä¼šé˜»å¡æ¸²æŸ“

```javascript
// âŒ é”™è¯¯ï¼šå¤§é‡å¾®ä»»åŠ¡ä¼šé˜»å¡æ¸²æŸ“
Promise.resolve().then(function loop() {
  // æ— é™å¾ªç¯åˆ›å»ºå¾®ä»»åŠ¡
  Promise.resolve().then(loop);
});

// é¡µé¢ä¼šå¡æ­»ï¼Œå› ä¸ºå¾®ä»»åŠ¡é˜Ÿåˆ—æ°¸è¿œæ¸…ä¸å®Œ
```

#### è¯¯åŒº 3ï¼šæ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½æ˜¯å®ä»»åŠ¡

```javascript
// Promise æ˜¯å¾®ä»»åŠ¡ï¼Œä¸æ˜¯å®ä»»åŠ¡
Promise.resolve().then(() => {
  console.log('å¾®ä»»åŠ¡');
});

setTimeout(() => {
  console.log('å®ä»»åŠ¡');
}, 0);

// è¾“å‡ºï¼šå¾®ä»»åŠ¡ å®ä»»åŠ¡
```

### å®é™…åº”ç”¨åœºæ™¯

#### 1. ä¼˜åŒ–æ€§èƒ½

```javascript
// âŒ æ¯æ¬¡æ“ä½œéƒ½è§¦å‘æ¸²æŸ“
for (let i = 0; i < 1000; i++) {
  element.style.left = i + 'px';
  // æµè§ˆå™¨å¯èƒ½æ¯æ¬¡éƒ½æ¸²æŸ“
}

// âœ… æ‰¹é‡æ›´æ–°ï¼Œåªæ¸²æŸ“ä¸€æ¬¡
requestAnimationFrame(() => {
  for (let i = 0; i < 1000; i++) {
    element.style.left = i + 'px';
  }
});
```

#### 2. ç¡®ä¿æ‰§è¡Œé¡ºåº

```javascript
// ç¡®ä¿åœ¨ DOM æ›´æ–°åæ‰§è¡Œ
element.textContent = 'new text';

// ä½¿ç”¨å¾®ä»»åŠ¡ç¡®ä¿åœ¨ä¸‹æ¬¡æ¸²æŸ“å‰æ‰§è¡Œ
Promise.resolve().then(() => {
  console.log(element.textContent); // 'new text'
});

// ä½¿ç”¨å®ä»»åŠ¡åœ¨æ¸²æŸ“åæ‰§è¡Œ
setTimeout(() => {
  console.log('æ¸²æŸ“å®Œæˆ');
}, 0);
```

#### 3. é¿å…é˜»å¡

```javascript
// âŒ é•¿æ—¶é—´è¿è¡Œçš„åŒæ­¥ä»£ç ä¼šé˜»å¡
function heavyTask() {
  for (let i = 0; i < 1000000000; i++) {
    // è€—æ—¶æ“ä½œ
  }
}

heavyTask(); // é˜»å¡ä¸»çº¿ç¨‹

// âœ… åˆ†ç‰‡æ‰§è¡Œ
function heavyTaskAsync(start, end) {
  for (let i = start; i < end; i++) {
    // å¤„ç†ä¸€éƒ¨åˆ†
  }
  
  if (end < 1000000000) {
    setTimeout(() => {
      heavyTaskAsync(end, end + 10000);
    }, 0);
  }
}

heavyTaskAsync(0, 10000);
```

## ğŸ’¡ é¢è¯•å›ç­”æŠ€å·§

### ğŸ¯ ä¸€å¥è¯å›ç­”ï¼ˆå¿«é€Ÿç‰ˆï¼‰

> äº‹ä»¶å¾ªç¯æ˜¯ JS å¤„ç†å¼‚æ­¥çš„æœºåˆ¶ï¼šå…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œç„¶åæ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰ï¼Œå†æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆsetTimeoutï¼‰ï¼Œå¾ªç¯å¾€å¤ã€‚å¾®ä»»åŠ¡ä¼˜å…ˆäºå®ä»»åŠ¡ã€‚

### ğŸ“£ å£è¯­åŒ–å›ç­”ï¼ˆæ¨èï¼‰

é¢è¯•æ—¶å¯ä»¥è¿™æ ·å›ç­”ï¼š

> "äº‹ä»¶å¾ªç¯æ˜¯ JavaScript å¤„ç†å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒæœºåˆ¶ã€‚å› ä¸º JS æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸èƒ½åŒæ—¶åšå¤šä»¶äº‹ï¼Œæ‰€ä»¥éœ€è¦äº‹ä»¶å¾ªç¯æ¥åè°ƒå¼‚æ­¥ä»»åŠ¡ã€‚
>
> æ ¸å¿ƒæ¦‚å¿µæœ‰ä¸‰ä¸ªï¼š**è°ƒç”¨æ ˆ**å­˜æ”¾æ­£åœ¨æ‰§è¡Œçš„ä»£ç ï¼Œ**ä»»åŠ¡é˜Ÿåˆ—**å­˜æ”¾å¾…æ‰§è¡Œçš„å›è°ƒï¼Œ**äº‹ä»¶å¾ªç¯**è´Ÿè´£æŠŠä»»åŠ¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡æ”¾åˆ°è°ƒç”¨æ ˆæ‰§è¡Œã€‚
>
> ä»»åŠ¡åˆ†ä¸¤ç§ï¼š**å®ä»»åŠ¡**å’Œ**å¾®ä»»åŠ¡**ã€‚å®ä»»åŠ¡åŒ…æ‹¬ script æ•´ä½“ä»£ç ã€setTimeoutã€setIntervalã€I/O ç­‰ï¼›å¾®ä»»åŠ¡åŒ…æ‹¬ Promise.thenã€MutationObserverã€queueMicrotask ç­‰ã€‚
>
> æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š
> 1. å…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼ˆè¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼‰
> 2. åŒæ­¥ä»£ç æ‰§è¡Œå®Œï¼Œæ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—
> 3. ç„¶åæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡
> 4. å†æ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡
> 5. å¾ªç¯å¾€å¤
>
> å…³é”®ç‚¹æ˜¯**å¾®ä»»åŠ¡ä¼˜å…ˆäºå®ä»»åŠ¡**ï¼Œè€Œä¸”æ¯æ¬¡ä¼šæ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡ï¼Œä½†åªæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ã€‚
>
> æ‰€ä»¥ Promise.then çš„å›è°ƒä¸€å®šæ¯” setTimeout å…ˆæ‰§è¡Œï¼Œå³ä½¿ setTimeout æ˜¯ 0 æ¯«ç§’ã€‚"

### æ¨èå›ç­”é¡ºåº

1. **å…ˆè¯´æ˜¯ä»€ä¹ˆ**ï¼š
   - "äº‹ä»¶å¾ªç¯æ˜¯ JavaScript å¤„ç†å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒæœºåˆ¶"
   - "ç”±äº JavaScript æ˜¯å•çº¿ç¨‹ï¼Œäº‹ä»¶å¾ªç¯ä½¿å…¶èƒ½å¤Ÿå¤„ç†éé˜»å¡æ“ä½œ"

2. **å†è¯´æ ¸å¿ƒç»„ä»¶**ï¼š
   - "è°ƒç”¨æ ˆï¼šå­˜å‚¨ä»£ç æ‰§è¡Œä½ç½®"
   - "ä»»åŠ¡é˜Ÿåˆ—ï¼šå­˜æ”¾å¾…æ‰§è¡Œçš„å›è°ƒå‡½æ•°"
   - "äº‹ä»¶å¾ªç¯ï¼šåè°ƒè°ƒç”¨æ ˆå’Œä»»åŠ¡é˜Ÿåˆ—"

3. **ç„¶åè¯´æ‰§è¡Œæµç¨‹**ï¼š
   - "æ‰§è¡ŒåŒæ­¥ä»£ç "
   - "æ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡"
   - "æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡"
   - "é‡å¤ä¸Šè¿°è¿‡ç¨‹"

4. **æœ€åè¯´åº”ç”¨**ï¼š
   - "ç†è§£å¼‚æ­¥ä»£ç çš„æ‰§è¡Œé¡ºåº"
   - "ä¼˜åŒ–æ€§èƒ½ï¼Œé¿å…é˜»å¡"
   - "æ­£ç¡®å¤„ç† Promise å’Œ setTimeout"

### é‡ç‚¹å¼ºè°ƒ

- âœ… **å¾®ä»»åŠ¡ä¼˜å…ˆäºå®ä»»åŠ¡æ‰§è¡Œ**
- âœ… **æ¯æ¬¡æ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡ï¼Œä½†åªæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡**
- âœ… **æµè§ˆå™¨æ¸²æŸ“åœ¨å®ä»»åŠ¡ä¹‹é—´è¿›è¡Œ**
- âœ… **é•¿æ—¶é—´è¿è¡Œçš„åŒæ­¥ä»£ç ä¼šé˜»å¡äº‹ä»¶å¾ªç¯**

### å¯èƒ½çš„è¿½é—®

**Q1: ä¸ºä»€ä¹ˆå¾®ä»»åŠ¡ä¼˜å…ˆäºå®ä»»åŠ¡ï¼Ÿ**

A:
- å¾®ä»»åŠ¡æ˜¯ JavaScript å¼•æ“æä¾›çš„ï¼Œä¼˜å…ˆçº§æ›´é«˜
- å¾®ä»»åŠ¡é€šå¸¸ç”¨äºå¤„ç† Promise ç­‰éœ€è¦å°½å¿«æ‰§è¡Œçš„æ“ä½œ
- è®¾è®¡ä¸Šä¿è¯äº† Promise çš„åŠæ—¶å“åº”

**Q2: setTimeout(fn, 0) çš„å»¶è¿Ÿæ˜¯å¤šå°‘ï¼Ÿ**

A:
- æµè§ˆå™¨æœ€å°å»¶è¿Ÿæ˜¯ 4msï¼ˆHTML5 è§„èŒƒï¼‰
- Node.js æœ€å°å»¶è¿Ÿæ˜¯ 1ms
- å®é™…å»¶è¿Ÿå–å†³äºå½“å‰ä»»åŠ¡é˜Ÿåˆ—çš„æƒ…å†µ

**Q3: å¦‚ä½•é¿å…äº‹ä»¶å¾ªç¯é˜»å¡ï¼Ÿ**

A:
- é¿å…é•¿æ—¶é—´è¿è¡Œçš„åŒæ­¥ä»£ç 
- ä½¿ç”¨ Web Worker å¤„ç†è€—æ—¶è®¡ç®—
- åˆ†ç‰‡æ‰§è¡Œå¤§ä»»åŠ¡
- ä½¿ç”¨ requestIdleCallback åœ¨ç©ºé—²æ—¶æ‰§è¡Œ

**Q4: Node.js å’Œæµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

A:
- Node.js æœ‰ 6 ä¸ªé˜¶æ®µï¼Œæµè§ˆå™¨åªæœ‰å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡
- Node.js æœ‰ process.nextTick å’Œ setImmediate
- Node.js çš„ setTimeout å’Œ setImmediate æ‰§è¡Œé¡ºåºä¸ç¡®å®š

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç»¼åˆç»ƒä¹ é¢˜

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');
  Promise.resolve().then(() => {
    console.log('3');
  });
}, 0);

new Promise((resolve) => {
  console.log('4');
  resolve();
}).then(() => {
  console.log('5');
  setTimeout(() => {
    console.log('6');
  }, 0);
});

setTimeout(() => {
  console.log('7');
  Promise.resolve().then(() => {
    console.log('8');
  });
}, 0);

Promise.resolve().then(() => {
  console.log('9');
});

console.log('10');

// æ‰§è¡Œæµç¨‹åˆ†æï¼š
// 1. åŒæ­¥ä»£ç ï¼š1 4 10
// 2. å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š5 9
// 3. å®ä»»åŠ¡ 1ï¼š2 â†’ å¾®ä»»åŠ¡ï¼š3
// 4. å®ä»»åŠ¡ 2ï¼š7 â†’ å¾®ä»»åŠ¡ï¼š8
// 5. å®ä»»åŠ¡ 3ï¼š6

// æœ€ç»ˆè¾“å‡ºï¼š1 4 10 5 9 2 3 7 8 6
```

### async/await ç»ƒä¹ é¢˜

```javascript
async function async1() {
  console.log('async1 start');
  await async2();
  console.log('async1 end');
  await async3();
  console.log('async1 end 2');
}

async function async2() {
  console.log('async2');
}

async function async3() {
  console.log('async3');
}

console.log('script start');

setTimeout(() => {
  console.log('setTimeout');
}, 0);

async1();

new Promise((resolve) => {
  console.log('promise1');
  resolve();
}).then(() => {
  console.log('promise2');
}).then(() => {
  console.log('promise3');
});

console.log('script end');

// è¾“å‡ºï¼š
// script start
// async1 start
// async2
// promise1
// script end
// async1 end
// promise2
// async3
// promise3
// async1 end 2
// setTimeout
```

### å®æˆ˜ï¼šå®ç°ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨

```javascript
class Scheduler {
  constructor(limit) {
    this.limit = limit;
    this.queue = [];
    this.running = 0;
  }
  
  add(task) {
    return new Promise((resolve) => {
      this.queue.push({ task, resolve });
      this.run();
    });
  }
  
  run() {
    while (this.running < this.limit && this.queue.length) {
      const { task, resolve } = this.queue.shift();
      this.running++;
      
      task().then((result) => {
        resolve(result);
        this.running--;
        this.run();
      });
    }
  }
}

// ä½¿ç”¨
const scheduler = new Scheduler(2);

const timeout = (time) => {
  return new Promise((resolve) => {
    setTimeout(resolve, time);
  });
};

const addTask = (time, order) => {
  scheduler.add(() => timeout(time)).then(() => {
    console.log(order);
  });
};

addTask(1000, '1');
addTask(500, '2');
addTask(300, '3');
addTask(400, '4');

// è¾“å‡ºï¼š2 3 1 4
// è§£é‡Šï¼šæœ€å¤šåŒæ—¶æ‰§è¡Œ 2 ä¸ªä»»åŠ¡
```

## ğŸ”— ç›¸å…³çŸ¥è¯†ç‚¹

- [async/await åŸç†](./async-await.md)
- [Promise è¯¦è§£](./promise.md)
- [é—­åŒ…](./closure.md)

## ğŸ“š å‚è€ƒèµ„æ–™

- [MDN - Event Loop](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop)
- [Jake Archibald - Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)
- [Node.js Event Loop](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)
